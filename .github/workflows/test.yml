name: CD Test

on:
#  push:
#    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version'     
        required: true

jobs:
  deployment:
    runs-on: ubuntu-latest
    strategy:
      matrix: 
        services: ['streetname-registry-api', 'streetname-registry-import-api', 'streetname-registry-projections']
    steps:
    - name: CD
      env:
        BUILD_URL: https://deploy.infra.basisregisters.test-vlaanderen.be/v3/basisregisters/${{matrix.services}}
        STATUS_URL: https://status.infra.basisregisters.test-vlaanderen.be/v3/basisregisters/${{matrix.services}}
      uses: informatievlaanderen/awscurl-polling-action@main
      with:
          environment: test
          version: ${{ github.event.inputs.version }}
          status-url: $STATUS_URL
          deploy-url: $BUILD_URL
          access-key: AKIAS3LRAVUDGIAPBRRM
          secret-key: ${{ secrets.VBR_AWS_BUILD_USER_SECRET_ACCESS_KEY_TEMP }}
          region: eu-west-1
          interval: 2
    - name: output
      shell: bash
      run: |
        echo build-uuid: ${{ steps.awscurl-polling-action.outputs.build-uuid }}
        echo Status: ${{ steps.awscurl-polling-action.outputs.status }}
        echo ${{ steps.awscurl-polling-action.outputs.final-message }}
